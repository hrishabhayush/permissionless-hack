(()=>{"use strict";console.log("🔧 Referral Extension Content Script Loaded"),console.log("🔧 Current URL:",window.location.href),console.log("🔧 Domain:",window.location.hostname);const o={username:"testuser",walletAddress:"0x742d35Cc6635C0532925a3b8D2c2C5c5b2b4b3b3"};console.log("🔧 Test user loaded:",o);const e={news:/\b(cnn\.com|bbc\.com|reuters\.com|ap\.org|npr\.org|washingtonpost\.com|nytimes\.com|wsj\.com)\b/i,fashion:/\b(vogue\.com|elle\.com|harpersbazaar\.com|gq\.com|fashionista\.com|wwd\.com)\b/i,sneaker:/\b(sneakernews\.com|hypebeast\.com|nicekicks\.com|solecollector\.com|kicksonfire\.com)\b/i,social:/\b(reddit\.com|twitter\.com|instagram\.com|tiktok\.com|youtube\.com|facebook\.com)\b/i,vision:/\b(visioncenter\.org|allaboutvision\.com|aao\.org|reviewofoptometry\.com)\b/i};function t(o){for(const[t,n]of Object.entries(e))if(n.test(o))return t;return"other"}function n(){console.log("🔧 Checking for links in the page...");const o=document.querySelectorAll("a[href]");console.log("🔧 Total links found:",o.length);let e=0,t=0;return o.forEach((o,n)=>{const s=o.href;s.includes("chatgpt.com")&&(e++,console.log("🔧 ChatGPT link found:",s)),s.includes("utm_source=chatgpt.com")&&(t++,console.log("🚨 UTM ChatGPT link found:",s),console.log("🚨 Link element:",o),console.log("🚨 Link text:",o.textContent),console.log("🚨 Link parent:",o.parentElement)),n<5&&s.startsWith("http")&&!s.includes("chatgpt.com")&&console.log(`🔧 External link ${n+1}:`,s)}),console.log("🔧 ChatGPT links:",e),console.log("🔧 UTM ChatGPT links:",t),{totalLinks:o.length,chatgptLinks:e,utmLinks:t}}function s(o){console.log("🔧 Processing message element:",o);const e=o.textContent||"";if(console.log("🔧 Message text length:",e.length),e.length>0){const n=function(o){console.log("🔧 Extracting sources from text:",o.substring(0,200)+"...");const e=new Set;[/\b([a-zA-Z0-9.-]+\.[a-zA-Z]{2,})\b/g,/(?:https?:\/\/)?(?:www\.)?([a-zA-Z0-9.-]+\.[a-zA-Z]{2,})(?:\/[^\s]*)?/g,/\(([^)]+\.[a-zA-Z]{2,})\)/g,/\[([^\]]+\.[a-zA-Z]{2,})\]/g].forEach(t=>{const n=o.match(t);n&&(console.log("🔧 Pattern matches found:",n),n.forEach(o=>{const t=o.replace(/^https?:\/\//,"").replace(/^www\./,"").replace(/\/.*$/,"").replace(/[()[\]]/g,"");t.includes(".")&&!t.includes(" ")&&e.add(t.toLowerCase())}))});const t=Array.from(e);return console.log("🔧 Extracted sources:",t),t}(e);if(n.length>0){console.log("🎯 Sources found in message:",n);const e=n.map(o=>({domain:o,category:t(o)}));console.log("📊 Categorized sources:",e);const s=o.querySelectorAll("a[href]");console.log("🔧 Links in this message:",s.length),s.forEach(o=>{const e=o.href;console.log("🔧 Message link:",e),e.includes("utm_source=chatgpt.com")&&console.log("🚨 FOUND UTM LINK IN MESSAGE:",e)})}}n()}function c(){console.log("🔧 Setting up message observer..."),n(),new MutationObserver(o=>{console.log("🔧 DOM mutation detected, mutations count:",o.length),o.forEach(o=>{"childList"===o.type&&o.addedNodes.forEach(o=>{if(o.nodeType===Node.ELEMENT_NODE){const e=o,t=e.querySelectorAll('[data-message-author-role="assistant"]');console.log("🔧 New assistant messages found:",t.length),t.forEach(s),e.matches('[data-message-author-role="assistant"]')&&(console.log("🔧 Added node is an assistant message"),s(e));const n=e.querySelectorAll("a[href]");n.length>0&&(console.log("🔧 New links added:",n.length),n.forEach(o=>{const e=o.href;e.includes("utm_source=chatgpt.com")&&console.log("🚨 NEW UTM LINK DETECTED:",e)}))}})}),setTimeout(n,100)}).observe(document.body,{childList:!0,subtree:!0}),console.log("🔧 Observer set up successfully")}function l(){const e=new URLSearchParams(window.location.search),t=e.get("utm_source");if(console.log("🔧 Checking URL parameters:",{fullURL:window.location.href,search:window.location.search,utmSource:t,allParams:Object.fromEntries(e.entries())}),"chatgpt.com"===t){console.log("🎯 CHATGPT REFERRAL DETECTED!"),console.log("🎯 This page was reached from ChatGPT");const t=e.get("ref");if(t)console.log("🔧 Referral parameter already exists:",t);else{console.log("🔧 Adding referral parameter...");const t=`${o.username}_${Date.now()}`;e.set("ref",t);const n=`${window.location.protocol}//${window.location.host}${window.location.pathname}?${e.toString()}${window.location.hash}`;console.log("🔄 URL modification:",{original:window.location.href,modified:n,referralParam:t}),window.history.replaceState({},"",n),console.log("✅ URL updated successfully!"),console.log("✅ New URL:",window.location.href),console.log("📊 Attribution Data:",{user:o.username,wallet:o.walletAddress,source:"chatgpt.com",destination:window.location.hostname,timestamp:(new Date).toISOString(),referralId:t}),chrome.runtime.sendMessage({type:"ATTRIBUTION_DETECTED",data:{user:o.username,wallet:o.walletAddress,source:"chatgpt.com",destination:window.location.hostname,originalUrl:window.location.href.replace(`&ref=${t}`,"").replace(`?ref=${t}`,""),modifiedUrl:window.location.href,referralId:t,timestamp:(new Date).toISOString()}}).catch(o=>console.log("🔧 Background script message failed:",o))}return!0}return console.log("🔧 No ChatGPT referral detected"),t&&console.log("🔧 Other UTM source found:",t),!1}function a(){console.log("🔧 Initializing referral extension..."),function(){const o=window.location.href,e=window.location.hostname;return!["chrome://","chrome-extension://","moz-extension://","about:","file://","localhost","127.0.0.1"].some(t=>o.startsWith(t)||e.includes("localhost"))||(console.log("🔧 Skipping internal/development page"),!1)}()&&(console.log("🔧 Running on relevant page:",window.location.hostname),l()?console.log("🎯 ChatGPT referral page detected!"):console.log("🔧 Regular page - no ChatGPT referral detected"))}"loading"===document.readyState?document.addEventListener("DOMContentLoaded",c):c(),setInterval(()=>{console.log("🔧 Periodic link check..."),n()},5e3),"loading"===document.readyState?document.addEventListener("DOMContentLoaded",a):a(),window.addEventListener("load",()=>{console.log("🔧 Window loaded, re-checking for referrals..."),setTimeout(l,500)}),console.log("🔧 Content script setup complete")})();