import{TxnBuilderTypes as o,BCS as d,HexString as A,SupraAccount as z}from"supra-l1-sdk-core";import B from"axios";var T=u=>{let t=new Array;return u.forEach(e=>{let n=e.value;t.push({struct:{address:n.address.toHexString().toString(),module:n.module_name.value,name:n.name.value,type_args:T(n.type_args)}})}),t},_=u=>{let t=new Array;for(let e=0;e<u.length;e++)t.push(Array.from(u[e]));return t},y=u=>{let t=u.toLowerCase();if(t.length<66)return t.startsWith("0x")?t=t.slice(2).padStart(64,"0"):t=t.padStart(64,"0"),"0x"+t;if(t.length===66&&t.startsWith("0x"))return t;throw new Error("Invalid address. With '0x', address length should be exactly 66 characters.")},S=u=>new Promise(t=>{setTimeout(t,u)});var x=(n=>(n.Success="Success",n.Failed="Failed",n.Pending="Pending",n))(x||{}),f=(r=>(r.CoinTransfer="CoinTransfer",r.EntryFunctionCall="EntryFunctionCall",r.ScriptCall="ScriptCall",r.AutomationRegistration="AutomationRegistration",r))(f||{});var R=6,E=300,b=1e3,p=15,w=BigInt(5e5),N=BigInt(100),v=300,I=1e3,m="0x0000000000000000000000000000000000000000000000000000000000000001",P=!1,O=!1,C=10,U=1020,M="SUPRA::RawTransaction",F="SUPRA::RawTransactionWithData";import D from"js-sha3";var J=class u{constructor(t,e=6){this.supraNodeURL=t,this.chainId=new o.ChainId(e)}static async init(t){let e=new u(t);return e.chainId=await e.getChainId(),e}async sendRequest(t,e,n){let r;if(t==!0)r=await B({method:"get",baseURL:this.supraNodeURL,url:e});else{if(n==null)throw new Error("For Post Request 'data' Should Not Be 'undefined'");r=await B({method:"post",baseURL:this.supraNodeURL,url:e,data:n,headers:{"Content-Type":"application/json"}})}if(r.status==404)throw new Error("Invalid URL, Path Not Found");return r}async getChainId(){return new o.ChainId(Number((await this.sendRequest(!0,"/rpc/v1/transactions/chain_id")).data))}async getGasPrice(){return BigInt((await this.sendRequest(!0,"/rpc/v1/transactions/estimate_gas_price")).data.mean_gas_price)}async fundAccountWithFaucet(t){let e=await this.sendRequest(!0,`/rpc/v1/wallet/faucet/${t.toString()}`);if(typeof e.data=="object"){if(e.data.hasOwnProperty("Accepted"))return{status:await this.waitForTransactionCompletion(e.data.Accepted),transactionHash:e.data.Accepted};throw new Error("something went wrong, getting unexpected response from rpc_node")}else throw new Error("try faucet later")}async isAccountExists(t){let e=await this.sendRequest(!0,`/rpc/v1/accounts/${t.toString()}`);return!(e.data===null||e.status===202)}async getAccountInfo(t){let e=await this.sendRequest(!0,`/rpc/v1/accounts/${t.toString()}`);if(e.data==null)throw new Error("Account Not Exists, Or Invalid Account Is Passed");return{sequence_number:BigInt(e.data.sequence_number),authentication_key:e.data.authentication_key}}async getAccountResources(t,e){let n=`/rpc/v1/accounts/${t.toString()}/resources?count=${e?.count??15}`;return e?.start&&(n+=`&start=${e.start}`),(await this.sendRequest(!0,n)).data.Resources}async getResourceData(t,e){let n=await this.sendRequest(!0,`/rpc/v1/accounts/${t.toString()}/resources/${e}`);if(n.data.result[0]==null)throw new Error("Resource not found");return n.data.result[0]}async getTransactionStatus(t){let e=await this.sendRequest(!0,`/rpc/v1/transactions/${t}`);return e.data==null?null:e.data.status=="Unexecuted"?"Pending":e.data.status=="Fail"?"Failed":e.data.status}getCoinChangeAmount(t,e){let n=new Map;e.forEach(i=>{if((i.type==="0x1::coin::CoinDeposit"||i.type==="0x1::coin::CoinWithdraw")&&"0x"+i.data.account.substring(2,i.data.account).padStart(64,"0")===t){if(i.type==="0x1::coin::CoinDeposit"){let a=n.get(i.data.coin_type);a!=null?n.set(i.data.coin_type,{totalDeposit:a.totalDeposit+BigInt(i.data.amount),totalWithdraw:a.totalWithdraw}):n.set(i.data.coin_type,{totalDeposit:BigInt(i.data.amount),totalWithdraw:BigInt(0)})}else if(i.type==="0x1::coin::CoinWithdraw"){let a=n.get(i.data.coin_type);a!=null?n.set(i.data.coin_type,{totalDeposit:a.totalDeposit,totalWithdraw:a.totalWithdraw+BigInt(i.data.amount)}):n.set(i.data.coin_type,{totalDeposit:BigInt(0),totalWithdraw:BigInt(i.data.amount)})}}});let r=[];return n.forEach((i,a)=>{r.push({coinType:a,amount:i.totalDeposit-i.totalWithdraw})}),r}getTransactionInsights(t,e){let n={coinReceiver:"",coinChange:[{amount:BigInt(0),coinType:""}],type:"EntryFunctionCall"};if(e.payload.Move.type==="entry_function_payload")if(e.payload.Move.function==="0x1::supra_account::transfer"){let r=BigInt(e.payload.Move.arguments[1]);t===e.header.sender.Move&&(r*=BigInt(-1)),n.coinReceiver=e.payload.Move.arguments[0],n.coinChange[0]={amount:r,coinType:"0x1::supra_coin::SupraCoin"},n.type="CoinTransfer"}else if(e.payload.Move.function==="0x1::supra_account::transfer_coins"||e.payload.Move.function==="0x1::coin::transfer"){let r=BigInt(e.payload.Move.arguments[1]);t===e.header.sender.Move&&(r*=BigInt(-1)),n.coinReceiver=e.payload.Move.arguments[0],n.coinChange[0]={amount:r,coinType:e.payload.Move.type_arguments[0]},n.type="CoinTransfer"}else e.status==="Success"&&(n.coinChange=this.getCoinChangeAmount(t,e.output.Move.events));else{if(e.payload.Move.type==="script_payload")n.type="ScriptCall";else if(e.payload.Move.type==="automation_registration_payload")n.type="AutomationRegistration";else throw new Error("something went wrong, found unsupported type of transaction");e.status==="Success"&&(n.coinChange=this.getCoinChangeAmount(t,e.output.Move.events))}return n}async getTransactionDetail(t,e){let n=await this.sendRequest(!0,`/rpc/v1/transactions/${e}`);return n.data==null?null:n.data.status==="Pending"||n.data.output===null||n.data.header===null?{txHash:e,sender:n.data.header.sender.Move,sequenceNumber:n.data.header.sequence_number,maxGasAmount:n.data.header.max_gas_amount,gasUnitPrice:n.data.header.gas_unit_price,gasUsed:void 0,transactionCost:void 0,txExpirationTimestamp:Number(n.data.header.expiration_timestamp.microseconds_since_unix_epoch),txConfirmationTime:void 0,status:n.data.status,events:void 0,blockNumber:void 0,blockHash:void 0,transactionInsights:this.getTransactionInsights(t.toString(),n.data),vm_status:void 0}:{txHash:e,sender:n.data.header.sender.Move,sequenceNumber:n.data.header.sequence_number,maxGasAmount:n.data.header.max_gas_amount,gasUnitPrice:n.data.header.gas_unit_price,gasUsed:n.data.output?.Move.gas_used,transactionCost:n.data.header.gas_unit_price*n.data.output?.Move.gas_used,txExpirationTimestamp:Number(n.data.header.expiration_timestamp.microseconds_since_unix_epoch),txConfirmationTime:Number(n.data.block_header.timestamp.microseconds_since_unix_epoch),status:n.data.status=="Fail"||n.data.status=="Invalid"?"Failed":n.data.status,events:n.data.output?.Move.events,blockNumber:n.data.block_header.height,blockHash:n.data.block_header.hash,transactionInsights:this.getTransactionInsights(t.toString(),n.data),vm_status:n.data.output.Move.vm_status}}async getAccountTransactionsDetail(t,e){let n=`/rpc/v1/accounts/${t.toString()}/transactions?count=${e?.count??15}`;e?.start&&(n+=`&start=${e.start}`);let r=await this.sendRequest(!0,n);if(r.data.record==null)throw new Error("Account Not Exists, Or Invalid Account Is Passed");let i=[];return r.data.record.forEach(a=>{i.push({txHash:a.hash,sender:a.header.sender.Move,sequenceNumber:a.header.sequence_number,maxGasAmount:a.header.max_gas_amount,gasUnitPrice:a.header.gas_unit_price,gasUsed:a.output.Move.gas_used,transactionCost:a.header.gas_unit_price*a.output.Move.gas_used,txExpirationTimestamp:Number(a.header.expiration_timestamp.microseconds_since_unix_epoch),txConfirmationTime:Number(a.block_header.timestamp.microseconds_since_unix_epoch),status:a.status==="Fail"||a.status==="Invalid"?"Failed":a.status,events:a.output.Move.events,blockNumber:a.block_header.height,blockHash:a.block_header.hash,transactionInsights:this.getTransactionInsights(t.toString(),a),vm_status:a.output.Move.vm_status})}),i}async getCoinTransactionsDetail(t,e){let n=`/rpc/v1/accounts/${t.toString()}/coin_transactions?count=${e?.count??15}`;e?.start&&(n+=`&start=${e?.start}`);let r=await this.sendRequest(!0,n);if(r.data.record==null)throw new Error("Account Not Exists, Or Invalid Account Is Passed");let i=[];return r.data.record.forEach(a=>{i.push({txHash:a.hash,sender:a.header.sender.Move,sequenceNumber:a.header.sequence_number,maxGasAmount:a.header.max_gas_amount,gasUnitPrice:a.header.gas_unit_price,gasUsed:a.output.Move.gas_used,transactionCost:a.header.gas_unit_price*a.output.Move.gas_used,txExpirationTimestamp:Number(a.header.expiration_timestamp.microseconds_since_unix_epoch),txConfirmationTime:Number(a.block_header.timestamp.microseconds_since_unix_epoch),status:a.status==="Fail"||a.status==="Invalid"?"Failed":a.status,events:a.output.Move.events,blockNumber:a.block_header.height,blockHash:a.block_header.hash,transactionInsights:this.getTransactionInsights(t.toString(),a),vm_status:a.output.Move.vm_status})}),{transactions:i,cursor:r.data.cursor}}async getAccountCompleteTransactionsDetail(t,e=15){let n=await this.sendRequest(!0,`/rpc/v1/accounts/${t.toString()}/coin_transactions?count=${e}`),r=await this.sendRequest(!0,`/rpc/v1/accounts/${t.toString()}/transactions?count=${e}`),i=[];n.data.record!=null&&i.push(...n.data.record),r.data.record!=null&&i.push(...r.data.record);let a=i.filter((s,l,g)=>l===g.findIndex(h=>h.hash===s.hash));a.sort((s,l)=>s.block_header.timestamp.microseconds_since_unix_epoch<l.block_header.timestamp.microseconds_since_unix_epoch?1:-1);let c=[];return a.forEach(s=>{c.push({txHash:s.hash,sender:s.header.sender.Move,sequenceNumber:s.header.sequence_number,maxGasAmount:s.header.max_gas_amount,gasUnitPrice:s.header.gas_unit_price,gasUsed:s.output.Move.gas_used,transactionCost:s.header.gas_unit_price*s.output.Move.gas_used,txExpirationTimestamp:Number(s.header.expiration_timestamp.microseconds_since_unix_epoch),txConfirmationTime:Number(s.block_header.timestamp.microseconds_since_unix_epoch),status:s.status==="Fail"||s.status==="Invalid"?"Failed":s.status,events:s.output.Move.events,blockNumber:s.block_header.height,blockHash:s.block_header.hash,transactionInsights:this.getTransactionInsights(t.toString(),s),vm_status:s.output.Move.vm_status})}),c}async getCoinInfo(t){let e=await this.getResourceData(new A(t.split("::")[0]),`${m}::coin::CoinInfo<${t}>`);return{name:e.name,symbol:e.symbol,decimals:e.decimals}}async getAccountSupraCoinBalance(t){return BigInt((await this.getResourceData(t,"0x1::coin::CoinStore<0x1::supra_coin::SupraCoin>")).coin.value)}async getAccountCoinBalance(t,e){return BigInt((await this.getResourceData(t,`0x1::coin::CoinStore<${e}>`)).coin.value)}async invokeViewMethod(t,e,n){return(await this.sendRequest(!1,"/rpc/v1/view",{function:t,type_arguments:e,arguments:n})).data.result}async getTableItemByKey(t,e,n,r){return(await this.sendRequest(!1,`/rpc/v1/tables/${t}/item`,{key_type:e,value_type:n,key:r})).data}async waitForTransactionCompletion(t){for(let e=0;e<300;e++){let n=await this.getTransactionStatus(t);if(n===null||n=="Pending")await S(1e3);else return n}return"Pending"}async sendTx(t,e){(e?.enableTransactionSimulation??P)===!0&&await this.simulateTx(t);let n=await this.sendRequest(!1,"/rpc/v1/transactions/submit",t);return console.log("Transaction Request Sent, Waiting For Completion"),{txHash:n.data,result:(e?.enableWaitForTransaction??O)===!0?await this.waitForTransactionCompletion(n.data):"Pending"}}static getSupraTransactionSignatureMessage(t){let e=Uint8Array.from(Buffer.from(D.sha3_256(t instanceof o.RawTransaction?M:F),"hex")),n=new Uint8Array(d.bcsToBytes(t)),r=new Uint8Array(e.length+n.length);return r.set(e),r.set(n,e.length),r}static signSupraTransaction(t,e){return t.signBuffer(u.getSupraTransactionSignatureMessage(e))}static signSupraMultiTransaction(t,e){let n=new o.Ed25519Signature(u.signSupraTransaction(t,e).toUint8Array());return new o.AccountAuthenticatorEd25519(new o.Ed25519PublicKey(t.signingKey.publicKey),n)}getTransactionPayloadJSON(t){if(t instanceof o.TransactionPayloadEntryFunction)return{EntryFunction:{module:{address:t.value.module_name.address.toHexString().toString(),name:t.value.module_name.name.value},function:t.value.function_name.value,ty_args:T(t.value.ty_args),args:_(t.value.args)}};if(t instanceof o.TransactionPayloadAutomationRegistration){if(t.value instanceof o.AutomationRegistrationParamsV1)return{AutomationRegistration:{V1:{automated_function:{module:{address:t.value.value.automated_function.module_name.address.toHexString().toString(),name:t.value.value.automated_function.module_name.name.value},function:t.value.value.automated_function.function_name.value,ty_args:T(t.value.value.automated_function.ty_args),args:_(t.value.value.automated_function.args)},max_gas_amount:Number(t.value.value.max_gas_amount),gas_price_cap:Number(t.value.value.gas_price_cap),automation_fee_cap_for_epoch:Number(t.value.value.automation_fee_cap_for_epoch),expiration_timestamp_secs:Number(t.value.value.expiration_timestamp_secs),aux_data:_(t.value.value.aux_data)}}};throw new Error("Unknown variant of `AutomationRegistrationParams`")}else throw new Error("Unknown variant of `TransactionPayload`")}getRawTxnJSON(t){return{sender:t.sender.toHexString().toString(),sequence_number:Number(t.sequence_number),payload:this.getTransactionPayloadJSON(t.payload),max_gas_amount:Number(t.max_gas_amount),gas_unit_price:Number(t.gas_unit_price),expiration_timestamp_secs:Number(t.expiration_timestamp_secs),chain_id:t.chain_id.value}}getSendTxPayload(t,e){return{Move:{raw_txn:this.getRawTxnJSON(e),authenticator:{Ed25519:{public_key:t.pubKey().toString(),signature:u.signSupraTransaction(t,e).toString()}}}}}async sendTxUsingSerializedRawTransaction(t,e,n){let r=this.getSendTxPayload(t,o.RawTransaction.deserialize(new d.Deserializer(e)));return await this.sendTx(r,n)}async sendTxUsingSerializedRawTransactionAndSignature(t,e,n,r){let i={Move:{raw_txn:this.getRawTxnJSON(o.RawTransaction.deserialize(new d.Deserializer(n))),authenticator:{Ed25519:{public_key:t.toString(),signature:e.toString()}}}};return await this.sendTx(i,r)}async sendSponsorTransaction(t,e,n,r,i,a=[],c){let s=[];a.forEach(g=>{s.push(this.getED25519AuthenticatorJSON(g))});let l={Move:{raw_txn:this.getRawTxnJSON(n),authenticator:{FeePayer:{sender:this.getED25519AuthenticatorJSON(r),secondary_signer_addresses:e,secondary_signers:s,fee_payer_address:t,fee_payer_signer:this.getED25519AuthenticatorJSON(i)}}}};return await this.sendTx(l,c)}async sendMultiAgentTransaction(t,e,n,r,i){let a=[];r.forEach(s=>{a.push(this.getED25519AuthenticatorJSON(s))});let c={Move:{raw_txn:this.getRawTxnJSON(e),authenticator:{MultiAgent:{sender:this.getED25519AuthenticatorJSON(n),secondary_signer_addresses:t,secondary_signers:a}}}};return await this.sendTx(c,i)}getED25519AuthenticatorJSON(t){return{Ed25519:{public_key:Buffer.from(t.public_key.value).toString("hex"),signature:Buffer.from(t.signature.value).toString("hex")}}}createRawTxObjectInner(t,e,n,r){return new o.RawTransaction(new o.AccountAddress(t.toUint8Array()),e,n,r?.maxGas??w,r?.gasUnitPrice??N,r?.txExpiryTime??BigInt(Math.ceil(Date.now()/I)+v),this.chainId)}async createRawTxObject(t,e,n,r,i,a,c,s){let l=new o.TransactionPayloadEntryFunction(new o.EntryFunction(new o.ModuleId(new o.AccountAddress(new A(y(n)).toUint8Array()),new o.Identifier(r)),new o.Identifier(i),a,c));return this.createRawTxObjectInner(t,e,l,s)}async createSerializedRawTxObject(t,e,n,r,i,a,c,s){return d.bcsToBytes(await this.createRawTxObject(t,e,n,r,i,a,c,s))}createSerializedAutomationRegistrationTxPayloadRawTxObject(t,e,n,r,i,a,c,s,l,g,h,H,W){let q=new o.TransactionPayloadAutomationRegistration(new o.AutomationRegistrationParamsV1(new o.AutomationRegistrationParamsV1Data(new o.EntryFunction(new o.ModuleId(new o.AccountAddress(new A(y(n)).toUint8Array()),new o.Identifier(r)),new o.Identifier(i),a,c),s,l,g,h,H)));return d.bcsToBytes(this.createRawTxObjectInner(t,e,q,W))}static createSignedTransaction(t,e){return new o.SignedTransaction(e,new o.AccountAuthenticatorEd25519(new o.Ed25519PublicKey(t.pubKey().toUint8Array()),new o.Ed25519Signature(u.signSupraTransaction(t,e).toUint8Array())))}static deriveTransactionHash(t){return D.keccak256(d.bcsToBytes(t))}async transferSupraCoin(t,e,n,r){if(r?.optionalTransactionPayloadArgs&&!r?.optionalTransactionPayloadArgs?.maxGas){let a=BigInt(C);await this.isAccountExists(e)==!1&&(a=BigInt(U)),r.optionalTransactionPayloadArgs.maxGas=a}let i=this.getSendTxPayload(t,await this.createRawTxObject(t.address(),(await this.getAccountInfo(t.address())).sequence_number,m,"supra_account","transfer",[],[e.toUint8Array(),d.bcsSerializeUint64(n)],r?.optionalTransactionPayloadArgs));return await this.sendTx(i,r?.enableTransactionWaitAndSimulationArgs)}async transferCoin(t,e,n,r,i){let a=this.getSendTxPayload(t,await this.createRawTxObject(t.address(),(await this.getAccountInfo(t.address())).sequence_number,m,"supra_account","transfer_coins",[new o.TypeTagParser(r).parseTypeTag()],[e.toUint8Array(),d.bcsSerializeUint64(n)],i?.optionalTransactionPayloadArgs));return await this.sendTx(a,i?.enableTransactionWaitAndSimulationArgs)}async publishPackage(t,e,n,r){let i=new d.Serializer,a=[];for(let s=0;s<n.length;s++)a.push(new o.Module(Uint8Array.from(n[s])));d.serializeVector(a,i);let c=this.getSendTxPayload(t,await this.createRawTxObject(t.address(),(await this.getAccountInfo(t.address())).sequence_number,m,"code","publish_package_txn",[],[d.bcsSerializeBytes(e),i.getBytes()],r?.optionalTransactionPayloadArgs));return await this.sendTx(c,r?.enableTransactionWaitAndSimulationArgs)}async simulateTx(t){let e=t.Move.authenticator,n=JSON.parse(JSON.stringify(e));t.Move.authenticator=n,this.unsetAuthenticatorSignatures(t.Move.authenticator);let r=await this.sendRequest(!1,"/rpc/v1/transactions/simulate",t);if(t.Move.authenticator=e,r.data.output.Move.vm_status!=="Executed successfully")throw new Error("Transaction Can Be Failed, Reason: "+r.data.output.Move.vm_status);return console.log("Transaction Simulation Done"),r.data}unsetAuthenticatorSignatures(t){let e="0x"+"0".repeat(128);"Ed25519"in t?t.Ed25519.signature=e:"FeePayer"in t?(t.FeePayer.sender.Ed25519.signature=e,t.FeePayer.fee_payer_signer.Ed25519.signature=e,t.FeePayer.secondary_signers.forEach(n=>{n.Ed25519.signature=e})):(t.MultiAgent.sender.Ed25519.signature=e,t.MultiAgent.secondary_signers.forEach(n=>{n.Ed25519.signature=e}))}async simulateTxUsingSerializedRawTransaction(t,e){let n={Move:{raw_txn:this.getRawTxnJSON(o.RawTransaction.deserialize(new d.Deserializer(e))),authenticator:t}};return await this.simulateTx(n)}};export{d as BCS,R as DEFAULT_CHAIN_ID,P as DEFAULT_ENABLE_SIMULATION,N as DEFAULT_GAS_PRICE,C as DEFAULT_MAX_GAS_FOR_SUPRA_TRANSFER_WHEN_RECEIVER_EXISTS,U as DEFAULT_MAX_GAS_FOR_SUPRA_TRANSFER_WHEN_RECEIVER_NOT_EXISTS,w as DEFAULT_MAX_GAS_UNITS,p as DEFAULT_RECORDS_ITEMS_COUNT,v as DEFAULT_TX_EXPIRATION_DURATION,O as DEFAULT_WAIT_FOR_TX_COMPLETION,b as DELAY_BETWEEN_POOLING_REQUEST,A as HexString,E as MAX_RETRY_FOR_TRANSACTION_COMPLETION,I as MILLISECONDS_PER_SECOND,M as RAW_TRANSACTION_SALT,F as RAW_TRANSACTION_WITH_DATA_SALT,m as SUPRA_FRAMEWORK_ADDRESS,z as SupraAccount,J as SupraClient,x as TransactionStatus,f as TxTypeForTransactionInsights,o as TxnBuilderTypes};
//# sourceMappingURL=index.mjs.map